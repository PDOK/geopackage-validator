name: Pytest

on:
  - pull_request

jobs:
  build:

    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-24.04, ubuntu-22.04] # no ubuntugis @ ubuntu-24.04
        python-version: ['3.11', '3.10', '3.9', '3.8']
        exclude:
          - os: ubuntu-24.04
            python-version: '3.9'
    steps:
    - name: Checkout 🛎️
      uses: actions/checkout@v3
    - name: Set up Python ${{ matrix.python-version }} 🐍
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: install gdal
      id: gdal
      run: |
        sudo apt-get update || true # ignore erros becouse we can not install gdal from `ppa:ubuntugis/ppa` without apt errors
        echo available python3-gdal versions: $(apt-cache madison python3-gdal | cut -f2 -d "|" | tr -d " ")
        echo available libgdal-dev versions: $(apt-cache madison libgdal-dev | cut -f2 -d "|" | tr -d " ")
        export APT_GDAL_VERSION=$(apt-cache madison python3-gdal | head -n1 | cut -f2 -d "|" | tr -d " ")
        echo "using version ->${APT_GDAL_VERSION}<-"
        echo gdal_version=$(echo "${APT_GDAL_VERSION}" | cut -f1 -d '+') >> $GITHUB_OUTPUT
        sudo apt-get install python3-gdal
    - name: Install dependencies for test
      run: |
        python -m pip install --upgrade pip wheel
        python -m pip install setuptools==57.*
        python -m pip freeze
    - name: Install dependencies from config
      run: |
        # we need to pin GDAL here to match the python3-gdal
        pip3 install GDAL==${{steps.gdal.outputs.gdal_version}}
        pip3 install --no-cache-dir .[test]
    - name: Test with pytest
      run: |
        pytest -vv
    - name: Test with black
      run: |
        black --check --diff .
